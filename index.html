<!DOCTYPE html>
<html>
<head>

    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>链家可视化</title>
    <style>
        html,
        body,
        #viewDiv {
            padding: 0;
            margin: 0;
            height: 100%;
            width: 100%;
        }


    </style>

    <link rel="stylesheet" href="https://js.arcgis.com/4.2/esri/css/main.css">
    <script src="https://js.arcgis.com/4.2/"></script>
    <!--<link rel="stylesheet" href="http://localhost/jsapi/4.2/esri/css/main.css">-->
    <!--<script src="http://localhost/jsapi/4.2/"></script>-->
    <script>
        require([
            'esri/layers/FeatureLayer', 'esri/Graphic',
            'esri/layers/support/LabelClass',
            'esri/symbols/LabelSymbol3D',
            'esri/symbols/TextSymbol3DLayer',
            "esri/Map",
            "esri/views/SceneView",
            "esri/widgets/Search",
            "esri/geometry/Point",
            "esri/geometry/Polyline",
            "esri/geometry/Polygon",
            "esri/symbols/SimpleMarkerSymbol",
            "esri/symbols/SimpleLineSymbol",
            "esri/symbols/SimpleFillSymbol",
            "esri/layers/GraphicsLayer",
            'esri/config',
            "dojo/dom",
            "dojo/on", "esri/layers/MapImageLayer", "esri/renderers/SimpleRenderer",
            "esri/symbols/PolygonSymbol3D",
            "esri/symbols/ExtrudeSymbol3DLayer", './converter.js',
            "dojo/domReady!"
        ], function (FeatureLayer, Graphic, LabelClass, LabelSymbol3D, TextSymbol3DLayer, Map, SceneView, Search, Point, Polyline, Polygon, SimpleMarkerSymbol, SimpleLineSymbol, SimpleFillSymbol, GraphicsLayer, esriConfig, dom, on, MapImageLayer, SimpleRenderer, PolygonSymbol3D, ExtrudeSymbol3DLayer, converter) {

            esriConfig.request.corsEnabledServers.push("server.arcgisonline.com");
            graphicsLayer = new GraphicsLayer();
            renderer = new SimpleRenderer({
                symbol: new PolygonSymbol3D({
                    symbolLayers: [new ExtrudeSymbol3DLayer()]
                }),
                visualVariables: [{
                    type: "size",
                    field: "avgprice",
                    stops: [
                        {
                            value: 50000,
                            size: 200
                        },
                        {
                            value: 120000,
                            size: 700
                        }]
                }, {
                    type: "color",
                    field: "avgprice",
                    stops: [
                        {
                            value: 50000,
                            color: '#7CFC00'
                        },
                        {
                            value: 120000,
                            color: 'red'
                        }]
                }]
            });
            var template = {
                title: "小区名称: {name}",
                content: "<ul><li>小区均价：{avgprice}</li>"
                + "<li>建筑年代：{buildingyears} 年</li>"
                + "<li>建筑类型：{buildingtype} </li>"
                + "<li><a href='{url}' target='_blank'>{url}</a> </li>"
                +
                "</ul>",
                fieldInfos: [{
                    fieldName: "name"
                }, {
                    fieldName: 'avgprice'
                }, {
                    fieldName: "buildingyears"
                }, {
                    fieldName: "buildingtype"
                }, {
                    fieldName: "url"
                }]
            };
            graphicsLayer.renderer = renderer
            graphicsLayer.popupTemplate = template
            map = new Map({
                basemap: 'streets',
                ground: "world-elevation",
                layers: [graphicsLayer]
            });
            view = new SceneView({
                map: map,
                container: "viewDiv",
                center: [116.3314279277704, 39.977584565],
                zoom: 13
//                camera: {
//                    "position": {
//                        "x": 12957834.48096514,
//                        "y": 4870525.087057412,
//                        "z": 4312.611522917636,
//                        "spatialReference": {"latestWkid": 3857, "wkid": 102100}
//                    }, "heading": 0.04549291015287625, "tilt": 22.954148651777917
//                }
            });
//            view.on('click', function (e) {
//                console.log(e)
//            })
//            var xhr = new XMLHttpRequest()

            xhr.open('get', location.href.replace(/\/[^/]+$/, "/") + 'rb.json')
            xhr.onload = function () {
                var result = JSON.parse(xhr.responseText)
                var graphics_array = []
                result.forEach(function (e) {
                    if (!e[1]) return
                    var g = new Graphic()
                    var gcj02 = converter.bd09togcj02(e[2], e[3])
                    var gps = converter.gcj02towgs84(gcj02[0], gcj02[1])

                    g.geometry = new Polygon(buildPolygonFromPt({
                        longitude: gps[0],
                        latitude: gps[1]
                    }))
//                    g.geometry = new Polygon(buildPolygonFromPt({latitude: e[4] + 0.01185, longitude: e[3] - 0.00328}))
                    g.attributes = {
                        'name': e[0],
                        'avgprice': e[1],
                        'buildingyears': e[4],
                        'buildingtype': e[5],
                        'url': e[6]//encodeURI('http://bj.lianjia.com/xiaoqu/{0}/'.replace('{0}', e[6]))
                    };
                    graphics_array.push(g)
                })
                graphicsLayer.addMany(graphics_array)

            }
            xhr.send()

            function buildPolygonFromPt(pt) {
                var temp = {rings: [[]], spatialReference: {wkid: 4326}}
                var step = 0.0005
                temp.rings[0].push([pt.longitude - step, pt.latitude - step])
                temp.rings[0].push([pt.longitude - step, pt.latitude + step])
                temp.rings[0].push([pt.longitude + step, pt.latitude + step])
                temp.rings[0].push([pt.longitude + step, pt.latitude - step])
                temp.rings[0].push([pt.longitude - step, pt.latitude - step])
                return temp
            }

//
//            function bd09togcj02(bd_lon, bd_lat) {
//                var x = bd_lon - 0.0065;
//                var y = bd_lat - 0.006;
//                var z = Math.sqrt(x * x + y * y) - 0.00002 * Math.sin(y * x_PI);
//                var theta = Math.atan2(y, x) - 0.000003 * Math.cos(x * x_PI);
//                var gg_lng = z * Math.cos(theta);
//                var gg_lat = z * Math.sin(theta);
//                return [gg_lng, gg_lat]
//            };
//            var x_PI = 3.14159265358979324 * 3000.0 / 180.0;
//            var ee = 0.00669342162296594323;
//            var PI = 3.1415926535897932384626;
//            var a = 6378245.0;
//
//            function gcj02towgs84(lng, lat) {
//
//                var dlat = transformlat(lng - 105.0, lat - 35.0);
//                var dlng = transformlng(lng - 105.0, lat - 35.0);
//                var radlat = lat / 180.0 * PI;
//                var magic = Math.sin(radlat);
//                magic = 1 - ee * magic * magic;
//                var sqrtmagic = Math.sqrt(magic);
//                dlat = (dlat * 180.0) / ((a * (1 - ee)) / (magic * sqrtmagic) * PI);
//                dlng = (dlng * 180.0) / (a / sqrtmagic * Math.cos(radlat) * PI);
//                var mglat = lat + dlat;
//                var mglng = lng + dlng;
//                return [lng * 2 - mglng, lat * 2 - mglat]
//            }
//
//            var transformlat = function transformlat(lng, lat) {
//                var ret = -100.0 + 2.0 * lng + 3.0 * lat + 0.2 * lat * lat + 0.1 * lng * lat + 0.2 * Math.sqrt(Math.abs(lng));
//                ret += (20.0 * Math.sin(6.0 * lng * PI) + 20.0 * Math.sin(2.0 * lng * PI)) * 2.0 / 3.0;
//                ret += (20.0 * Math.sin(lat * PI) + 40.0 * Math.sin(lat / 3.0 * PI)) * 2.0 / 3.0;
//                ret += (160.0 * Math.sin(lat / 12.0 * PI) + 320 * Math.sin(lat * PI / 30.0)) * 2.0 / 3.0;
//                return ret
//            };
//
//            var transformlng = function transformlng(lng, lat) {
//                var ret = 300.0 + lng + 2.0 * lat + 0.1 * lng * lng + 0.1 * lng * lat + 0.1 * Math.sqrt(Math.abs(lng));
//                ret += (20.0 * Math.sin(6.0 * lng * PI) + 20.0 * Math.sin(2.0 * lng * PI)) * 2.0 / 3.0;
//                ret += (20.0 * Math.sin(lng * PI) + 40.0 * Math.sin(lng / 3.0 * PI)) * 2.0 / 3.0;
//                ret += (150.0 * Math.sin(lng / 12.0 * PI) + 300.0 * Math.sin(lng / 30.0 * PI)) * 2.0 / 3.0;
//                return ret
//            };

        });
    </script>
    <base href="http://bj.lianjia.com/xiaoqu/">
</head>

<body>
<div id="viewDiv"></div>


</body>
</html>